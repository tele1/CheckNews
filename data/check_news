#! /bin/bash


while IFS= read -r line4 ; do
	link4=$(awk '{print $2}' <<< $line4)
	number4=$(awk '{print $1}' <<< $line4)
	OLD_MARKER="data/manager.scr/markers/${number4}.0.marker"
	TIME=$(date +"%Y-%m-%d %T")


	if [ -s data/manager.scr/filters/${number4}.filter ]; then
		curl -s "$link4" | $(cat data/manager.scr/filters/${number4}.filter) > data/tmp/${number4}.new.marker
	else
		curl -s "$link4" > data/tmp/${number4}.new.marker
	fi


	if cmp -s "$OLD_MARKER" data/tmp/${number4}.new.marker ; then
		echo " " >> data/logs/fu.log
		echo "$TIME -- Nothing changed" | tee -a data/logs/fu.log
		echo "  - $link4" | tee -a data/logs/fu.log
	else
		echo " " >> data/logs/fu.log
		echo "$TIME -- Something changed" | tee -a data/logs/fu.log
		echo "  + $link4" | tee -a data/logs/fu.log
		comm -31 "$OLD_MARKER" data/tmp/${number4}.new.marker >> data/logs/fu.log
		xdg-open "$link4"
	fi

done < "data/manager.scr/lists"


